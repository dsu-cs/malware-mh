#Requires -RunAsAdministrator

function shortcut {
	# check if the schortcut exists
	$shortcutFile = Join-Path -Path $([Environment]::GetFolderPath("Desktop")) -ChildPath "Toggle Defender.lnk"
	if (!$(Test-Path -Path $shortcutFile)) {
		Write-Host "Desktop shortcut does not exist. Creating one..."
		
		# create the shortcut
		$scriptFile = $MyInvocation.PSCommandPath
		$shell = New-Object -ComObject WScript.Shell
		$shortcut = $shell.CreateShortcut($shortcutFile)
		$shortcut.TargetPath = Join-Path -Path $PSHOME -ChildPath "powershell.exe"
		$shortcut.Arguments = "$scriptFile -ExecutionPolicy Bypass -File"
		$shortcut.IconLocation = "C:\Program Files\Windows Defender\MpCmdRun.exe"
		$shortcut.Save()

		# set the shortcut to run as administrator
		$bytes = [System.IO.File]::ReadAllBytes($shortcutFile)
		$bytes[0x15] = $bytes[0x15] -bor 0x20 # sets byte 21's bit 6 to on
		[System.IO.File]::WriteAllBytes($shortcutFile, $bytes)
	}
}

function askToReboot {
	# changes will not be applied to Defender until the system is rebooted - ask the user
	switch ($(Read-Host("Ok to reboot now (immediately)? [y/n]")).ToLower() ) {
		"y" {
			Write-Host "Rebooting..."
			Restart-Computer 
		}
		"n" {
			Write-Host "Changes will not be applied until the system is rebooted."
			Exit
		}
		Default {
			Write-Host "Invalid input."
			askToReboot
		}
	}
	
}

# see if there is a shortcut on the desktop for this script
shortcut

$regPath = 'HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender\'
# check to see if the registry key exists, if not create it and set it to disable Defender
try {
	Get-ItemPropertyValue  -Path $regPath -Name DisableAntiSpyware | Out-Null
}
catch {
	Write-Host "Registry key not found, adding: HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender\DisableAntiSpyware"
	New-ItemProperty $regPath -Name 'DisableAntiSpyware' -Value 1 -PropertyType 'DWORD' | Out-Null
	Write-Host "`t[+] key added" -ForegroundColor Green
	Write-Host "`t[-] Defender will be disabled on next reboot." -ForegroundColor Red
	askToReboot
}

# the registry key already exists, toggle the value
$defenderStatus = Get-ItemPropertyValue  -Path $regPath -Name DisableAntiSpyware
if ($defenderStatus -eq 1){
	Write-Host "Defender is set to disabled. Enabling it..." 
	Set-ItemProperty -Path $regPath -Name 'DisableAntiSpyware' -Value 0 | Out-Null
	Write-Host "`t [+] Defender will be enabled on next reboot." -ForegroundColor Green
}
else {
	Write-Host "Defender is set to enabled. Disabling it..." 
	Set-ItemProperty -Path $regPath -Name 'DisableAntiSpyware' -Value 1 | Out-Null
	Write-Host "`t[-] Defender will be disabled on next reboot." -ForegroundColor Red
}
askToReboot