<#
	.SYNOPSIS

	.DESCRIPTION

	.PARAMETER noChecks
		Switch parameter to skip validation checks (not recommended).

	.LINK
		https://github.com/mandiant/flare-vm
		https://github.com/mandiant/VM-Packages
#>
param (
  [string]$password = $null,
  [switch]$noPassword,
  [string]$customConfig = $null,
  [switch]$noWait,
  [switch]$noGui,
  [switch]$noReboots,
  [switch]$noChecks
)
$ErrorActionPreference = "Stop"

function Get-ChocolateyVersion {
	$chocoVersionGood = $false
	if(${Env:ChocolateyInstall} -and (Test-Path "${Env:ChocolateyInstall}\bin\choco.exe")) {
    	$version = choco --version
    	return $([System.Version]$version -ge [System.Version]"0.10.13")
	}
	else {
		return $false
	}
}

# set path to user's desktop
$desktopPath = [Environment]::GetFolderPath("Desktop")
Set-Location -Path $desktopPath -PassThru | Out-Null

if (-not $noChecks.IsPresent) {
	# ensure script is ran as administrator
	Write-Host "[+] Checking if script is running as administrator..."
	$currentPrincipal = New-Object Security.Principal.WindowsPrincipal([Security.Principal.WindowsIdentity]::GetCurrent())
	if (-Not $currentPrincipal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
		Write-Host "`t[!] Please run this script as administrator" -ForegroundColor Red
		Read-Host "Press any key to exit..."
		exit 1
	} else {
		Write-Host "`t[+] Running as administrator" -ForegroundColor Green
		Start-Sleep -Milliseconds 500
	}

	# ensure execution policy is unrestricted
	Write-Host "[+] Checking if execution policy is unrestricted..."
	if ((Get-ExecutionPolicy).ToString() -ne "Unrestricted") {
		Write-Host "`t[!] Please run this script after updating your execution policy to unrestricted" -ForegroundColor Red
		Write-Host "`t[-] Hint: Set-ExecutionPolicy Unrestricted" -ForegroundColor Yellow
		Read-Host "Press any key to exit..."
		exit 1
	} else {
		Write-Host "`t[+] Execution policy is unrestricted" -ForegroundColor Green
		Start-Sleep -Milliseconds 500
	}

	# check if Tamper Protection is disabled
	Write-Host "[+] Checking if Windows Defender Tamper Protection is disabled..."
	if ($(Get-MpComputerStatus).IsTamperProtected) {
		Write-Host "`t[!] Please disable Tamper Protection, reboot, and rerun installer" -ForegroundColor Red    
		Write-Host "`t[+] You are welcome to continue, but may experience errors downloading or installing packages" -ForegroundColor Yellow
		Write-Host "`t[-] Do you still wish to proceed? (Y/N): " -ForegroundColor Yellow -NoNewline
		$response = Read-Host
		if ($response -notin @("y","Y")) {
			exit 1
		}
	}
	else {
			Write-Host "`t[+] Tamper Protection is disabled" -ForegroundColor Green
			Start-Sleep -Milliseconds 500
	}

	# check if Defender is disabled
	Write-Host "[+] Checking if Windows Defender service is disabled..."
	Set-MpPreference -DisableRealtimeMonitoring $true
	if ($(Get-MpComputerStatus).RealTimeProtectionEnabled) {
			Write-Host "`t[!] Please disable Windows Defender through Group Policy, reboot, and rerun installer" -ForegroundColor Red
			Write-Host "`t[+] Hint: https://stackoverflow.com/questions/62174426/how-to-permanently-disable-windows-defender-real-time-protection-with-gpo" -ForegroundColor Yellow
			Write-Host "`t[+] Hint: https://www.windowscentral.com/how-permanently-disable-windows-defender-windows-10" -ForegroundColor Yellow
			Write-Host "`t[+] Hint: https://github.com/jeremybeaume/tools/blob/master/disable-defender.ps1" -ForegroundColor Yellow
			Write-Host "`t[+] You are welcome to continue, but may experience errors downloading or installing packages" -ForegroundColor Yellow
			Write-Host "`t[-] Do you still wish to proceed? (Y/N): " -ForegroundColor Yellow -NoNewline
			$response = Read-Host
			if ($response -notin @("y","Y")) {
				exit 1
			}
		} 
		else {
			Write-Host "`t[+] Defender is disabled" -ForegroundColor Green
			Start-Sleep -Milliseconds 500
	}
	
	# check if system is a virtual machine
	$virtualModels = @('VirtualBox', 'VMware Virtual Platform', 'Virtual Machine')
	if ((Get-WmiObject win32_computersystem).model -notin $virtualModels) {
		Write-Host "`t[!] You are not on a virual machine or have hardened your machine to not appear as a virtual machine" -ForegroundColor Red
		Write-Host "`t[!] Please do NOT install this on your host system as it can't be uninstalled completely" -ForegroundColor Red
		Write-Host "`t[!] ** Please only install on a virtual machine **" -ForegroundColor Red
		Write-Host "`t[!] ** Only continue if you know what you are doing! **" -ForegroundColor Red
		Write-Host "[-] Do you still wish to proceed? (Y/N): " -ForegroundColor Yellow -NoNewline
		$response = Read-Host
		if ($response -notin @("y","Y")) {
			exit 1
		}
	}

	# prompt user to remind them to take a snapshot
	Write-Host "[-] Have you taken a VM snapshot to ensure you can revert to pre-installation state? (Y/N): " -ForegroundColor Yellow -NoNewline
	$response = Read-Host
	if ($response -notin @("y","Y")) {
		exit 1
	}
}

# check Chocolatey and Boxstarter versions
$chocolateyVersionGood = Get-ChocolateyVersion
if(${Env:ChocolateyInstall} -and (Test-Path "${Env:ChocolateyInstall}\bin\choco.exe")) {
    $version = choco --version
    $chocolateyVersionGood = [System.Version]$version -ge [System.Version]"0.10.13"
}

# install Chocolatey and Boxstarter if needed
if (-not $chocolateyVersionGood) {
	Write-Host "[+] Attempting to install Chocolatey"
	[System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
	iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))

	if (Get-ChocolateyVersion){
		Write-Host "`t[+] Chocolatey installed successfully." -ForegroundColor Green
	    Start-Sleep -Milliseconds 500
	}
	else{
		Write-Host "`t[!] Chocolatey was not installed successfully." -ForegroundColor Red
		exit 1
	}
}

# set Chocolatey options
Write-Host "[+] Updating Chocolatey settings..."
choco sources add -n="vm-packages" -s "$desktopPath;.;https://www.myget.org/F/vm-packages/api/v2;https://myget.org/F/vm-packages/api/v2" --priority 2
choco sources add -n="fireeye" -s "$desktopPath;.;https://www.myget.org/F/fireeye/api/v2" --priority 3
choco feature enable -n allowGlobalConfirmation
choco feature enable -n allowEmptyChecksums
$cache = "${Env:LocalAppData}\ChocoCache"
New-Item -Path $cache -ItemType directory -Force | Out-Null
choco config set cacheLocation $cache

# Set power options to prevent installs from timing out
powercfg -change -monitor-timeout-ac 0 | Out-Null
powercfg -change -monitor-timeout-dc 0 | Out-Null
powercfg -change -disk-timeout-ac 0 | Out-Null
powercfg -change -disk-timeout-dc 0 | Out-Null
powercfg -change -standby-timeout-ac 0 | Out-Null
powercfg -change -standby-timeout-dc 0 | Out-Null
powercfg -change -hibernate-timeout-ac 0 | Out-Null
powercfg -change -hibernate-timeout-dc 0 | Out-Null

# remove recent searches, web searches, etc. from start menu
Write-Host "[+] Cleaning start menu"
$regPath = 'HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Search'
New-ItemProperty -Path $regPath -Name "BingSearchEnabled" -Value 0 -PropertyType DWord
$regPath = "HKLM:\SOFTWARE\Microsoft\Windows\Windows Search"
New-ItemProperty -Path $regPath -Name "EnableDynamicContentInWSB" -Value 0 -PropertyType DWord

# turn off Edge first start wizard and enable the setting for blank tab pages
Write-Host "[+] Cleaning Microsoft Edge"
$regPath = "HKLM:\SOFTWARE\Microsoft\Enrollments\"
New-Item -Path $regPath -Name "FFFFFFFF-FFFF-FFFF-FFFF-FFFFFFFFFFFF"
$regPath = "HKLM:\SOFTWARE\Microsoft\Enrollments\FFFFFFFF-FFFF-FFFF-FFFF-FFFFFFFFFFFF"
New-ItemProperty -Path $regPath -Name "EnrollmentState" -Value 1 -PropertyType DWord
New-ItemProperty -Path $regPath -Name "EnrollmentType" -Value 0 -PropertyType DWord
New-ItemProperty -Path $regPath -Name "IsFederated" -Value 0 -PropertyType DWord
$regPath = "HKLM:\SOFTWARE\Microsoft\Provisioning\OMADM\Accounts\"
New-Item -Path $regPath -Name "FFFFFFFF-FFFF-FFFF-FFFF-FFFFFFFFFFFF"
$regPath = "HKLM:\SOFTWARE\Microsoft\Provisioning\OMADM\Accounts\FFFFFFFF-FFFF-FFFF-FFFF-FFFFFFFFFFFF"
New-ItemProperty -Path $regPath -Name "Flags" -Value 0x00d6fb7f -PropertyType DWord
New-ItemProperty -Path $regPath -Name "AcctUId" -Value "0x000000000000000000000000000000000000000000000000000000000000000000000000" -PropertyType string
New-ItemProperty -Path $regPath -Name "RoamingCount" -Value 0 -PropertyType DWord
New-ItemProperty -Path $regPath -Name "SslClientCertReference" -Value "MY;User;0000000000000000000000000000000000000000" -PropertyType string
New-ItemProperty -Path $regPath -Name "ProtoVer" -Value "1.2" -PropertyType string
$regPath = "HKLM:\SOFTWARE\Policies\Microsoft\"
New-Item -Path $regPath -Name "Edge"
$regPath = "HKLM:\SOFTWARE\Policies\Microsoft\Edge"
New-ItemProperty -Path $regPath -Name "NewTabPageLocation" -Value "about://blank" -PropertyType string

Write=Host "[+] Getting Office, this will take a bit..."
Invoke-WebRequest -Uri "https://download.microsoft.com/download/2/7/A/27AF1BE6-DD20-4CB4-B154-EBAB8A7D4A7E/officedeploymenttool_15726-20202.exe" -OutFile $($desktopPath+"\office.exe")
Invoke-Expression($desktopPath+"\office.exe /extract:./office /passive /quiet")
Write-Host "`t[-] Did you move the office-config.xml file into the office folder (Y/N): " -ForegroundColor Yellow -NoNewline
$response = Read-Host
if ($response -in @("y","Y")) {
	Invoke-Expression($desktopPath+"\office\setup.exe /download "+$desktopPath+"\office-config.xml")
	Invoke-Expression($desktopPath+"\office\setup.exe /configure "+$desktopPath+"\office\office-config.xml")
}
else{
	Write-Host "`t[!] Skipping Office install, no office-config.xml present" -ForegroundColor Red    	
}
Remove-Item $($desktopPath+"\office") -Confirm:$false -Force -Recurse
Remove-Item $($desktopPath+"\office.exe") -Confirm:$false -Force


# unbloat Windows: remove AppxPackages, reg keys, protect privacy, cleanup scheduled tasks, etc
iwr -useb https://raw.githubusercontent.com/Sycnex/Windows10Debloater/master/Windows10SysPrepDebloater.ps1 | iex